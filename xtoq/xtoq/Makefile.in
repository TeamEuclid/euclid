# Copyright (c) Jess VanDerwalker <washu@sonic.net>
#
# Cocoa/Obj-C makefile in xtoq/xtoq/ directory
#

# @configure_input@

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@

PACKAGE = @PACKAGE_NAME@
VERSION = @PACKAGE_VERSION@

PATHTOXTOQSRC = ../../src

CC = clang
CFLAGS = -Wall -g -O0
INCLUDES = -I../../src -I/opt/X11/include
LDFLAGS = -L/opt/X11/lib -lxcb-util -lxcb-damage -lxcb-composite -lxcb-xfixes -lxcb-render -lxcb-shape -lxcb-image -lxcb-shm -lxcb
FRAMEWORKS = Cocoa AppKit
IBTOOL = ibtool

SOURCES = main.m XtoqApplication.m XtoqController.m XtoqWindow.m DisplayNumberController.m XtoqImageRep.m XtoqView.m
CSOURCES = $(PATHTOXTOQSRC)/xtoq.c $(PATHTOXTOQSRC)/util.c
COBJS = $(CSOURCES:.c=.o)
Xibdir = en.lproj

# Build the list of frameworks
FRAMEWORKFLAGS = $(addprefix -framework , $(FRAMEWORKS))
all: @PACKAGE_NAME@

# Compile files and build sources
$(PACKAGE): $(SOURCES) $(SOURCES) Info.plist
	$(CC) $(CPPFLAGS) $(CFLAGS) $(INCLUDES) $(LDFLAGS) -o $@ $(SOURCES) $(COBJS) $(FRAMEWORKFLAGS)

$CSOURCES:
	cd ../../src && $(MAKE)

$(XIBDIR)/DisplayNumberDialog.nib: DisplayNumberDialog.xib
	$(IBTOOL) DisplayNumberDialog.xib --compile $(XIBDIR)/DisplayNumberDialog.nib

# Replace necessary strings in Info.plist and rename
Info.plist: @PACKAGE_NAME@-Info.plist
	cp @PACKAGE_NAME@-Info.plist Info.plist
	sed -e 's/$${EXECUTABLE_NAME}/$(PACKAGE)/' \
        -e 's/$${PRODUCT_NAME.*}/$(PACKAGE)/' \
        -e 's/$${MACOSX_DEPLOYMENT_TARGET}/$(MACOSXTARGET))/' \
        < @PACKAGE_NAME@-Info.plist > Info.plist

# Rebuild config.status and Makefiles is configure changes
Makefile: Makefile.in ../../config.status
	cd ../.. && ./config.status $(XCODESRCDIR)/$@

config.status: ../../configure
	cd ../.. && ./config.status --recheck

# Installation
install:
	install -d $(bindir)/$(APPNAME)
	install -m 0755 xtoq $(bindir)/$(APPNAME)
	install -m 0655 xtoq-Info.plist $(bindir)/$(APPNAME)
	install -d $(bindir)/$(APPNAME)/en.lproj
	install -m 0655 en.lproj/* $(bindir)/$(APPNAME)/en.lproj

uninstall:
	-rm -r $(bindir)/$(APPNAME)

clean:
	rm -f $(PACKAGE)
	rm -rf $(PACKAGE).dSYM
	rm -f Info.plist

.PHONY: all clean install uninstall